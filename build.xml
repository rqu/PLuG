<project name="disl" default="prepare-all" basedir=".">

	<property file="build.properties" />
	<property file="disl.version" />

	<path id="buildpath">
		<pathelement location="${asm.path}" />
		<pathelement location="${bin}" />
	</path>

	<!-- it automatically compiles all other necessary stuff :) -->
	<target name="compile-tlvinserter">
		<mkdir dir="${bin}" />
		<javac srcdir="${src.disl}" includes="ch/usi/dag/disl/utilinstr/tlvinserter/" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="prepare-extendedthread" depends="compile-tlvinserter">
		<mkdir dir="bin-thread/java/lang" />
		<java fork="true" classname="ch.usi.dag.disl.utilinstr.tlvinserter.ExtendThread">
			<classpath refid="buildpath" />
		</java>
		<mkdir dir="${build}" />
		<jar basedir="bin-thread" destfile="${extendedthread.path}" />
		<delete dir="bin-thread" />
	</target>

	<target name="compile-dynamicbypass" depends="prepare-extendedthread">
		<mkdir dir="${bin}" />
		<javac srcdir="${src.dynbypass}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
			<compilerarg value="-Xbootclasspath/p:${extendedthread.path}" />
		</javac>
		<delete file="${extendedthread.path}" />
	</target>

	<target name="compile-disl" depends="compile-dynamicbypass">
		<javac srcdir="${src.disl}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="compile-agent-java" depends="compile-dynamicbypass">
		<javac srcdir="${src.agent.java}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="compile-agent-c">
		<exec executable="make" dir="${src.agent.c}" />
	</target>

	<target name="compile-reserver">
		<javac srcdir="${src.reserver}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="compile-redispatch">
		<javac srcdir="${src.redispatch}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="compile-reagent">
		<exec executable="make" dir="${src.reagent}" />
	</target>

	<target name="compile-test" depends="compile-disl,compile-reserver,compile-redispatch">
		<javac srcdir="${src.test}" destdir="bin" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="compile" depends="compile-disl,compile-agent-java,compile-agent-c,compile-test,compile-reserver,compile-redispatch" />

	<target name="package-dislserver" depends="compile-disl">
		<jar basedir="${bin}" destfile="${build}/disl-server.jar"
			includes="ch/usi/dag/disl/**,ch/usi/dag/dislserver/**"
			excludes="ch/usi/dag/disl/test/**,ch/usi/dag/disl/testtools/**">

			<manifest>
				<attribute name="Class-Path" value="${asm.lib}" />
				<attribute name="Main-Class" value="ch.usi.dag.dislserver.DiSLServer" />
				<attribute name="DiSL-Version" value="${disl.version}" />
			</manifest>
		</jar>
	</target>

	<target name="compile-dynamicbypass-afterbootstrap">
		<mkdir dir="${build.afterbootstrap}" />
		<javac srcdir="${src.dynbypass.act}" destdir="${build.afterbootstrap}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath" />
		</javac>
	</target>

	<target name="package-dislagent-java" depends="compile-agent-java,compile-dynamicbypass,compile-dynamicbypass-afterbootstrap">

		<!-- rename after bootstrap class -->
		<move file="${build.afterbootstrap}/ch/usi/dag/disl/dynamicbypass/DynamicBypassCheck.class"
			tofile="${build.afterbootstrap}/DynamicBypassCheck-AfterBootstrap.class" />

		<jar basedir="${bin}" destfile="${build}/disl-agent.jar"
			includes="ch/usi/dag/dislagent/**,ch/usi/dag/disl/dynamicbypass/**">

			<manifest>
				<attribute name="Premain-Class" value="ch.usi.dag.dislagent.DiSLAgent" />
				<attribute name="Can-Redefine-Classes" value="true" />
				<attribute name="DiSL-Version" value="${disl.version}" />
			</manifest>

			<!-- include after bootstrap class -->
			<fileset file="${build.afterbootstrap}/DynamicBypassCheck-AfterBootstrap.class" />
		</jar>

		<!-- delete dir with after bootstrap class -->
		<delete dir="${build.afterbootstrap}" />
	</target>

	<target name="package-reserver" depends="compile-reserver">
		<jar basedir="${bin}" destfile="${build}/dislre-server.jar"
			includes="ch/usi/dag/dislreserver/**">
			<manifest>
				<attribute name="Class-Path" value="${asm.lib}" />
				<attribute name="Main-Class" value="ch.usi.dag.dislreserver.DiSLREServer" />
				<attribute name="DiSL-Version" value="${disl.version}" />
			</manifest>
		</jar>
	</target>

	<target name="package-redispatch" depends="compile-redispatch">
		<jar basedir="${bin}" destfile="${build}/dislre-dispatch.jar"
			includes="ch/usi/dag/dislre/**">
		</jar>
	</target>

	<target name="package" depends="package-dislserver,package-dislagent-java,package-reserver,package-redispatch,compile-agent-c,compile-reagent" />

	<target name="eclipse-agent" description="creates simple agent jar file for eclipse">
		<mkdir dir="build" />
		<jar jarfile="build/eclipse-agent.jar">
			<manifest>
				<attribute name="Premain-Class" value="ch.usi.dag.disl.testtools.agent.Agent" />
			</manifest>
		</jar>
	</target>

	<target name="eclipse-dynamicbypass" depends="compile-dynamicbypass"
		description="creates support library for DiSL development under eclipse">

		<jar basedir="${bin}" destfile="${build}/eclipse-dynamicbypass.jar"
			includes="ch/usi/dag/disl/dynamicbypass/" />
	</target>

	<target name="eclipse" depends="eclipse-dynamicbypass,eclipse-agent" />

	<target name="copy-asm">
		<copy file="${asm.path}" tofile="${build}/${asm.lib}" />
	</target>

	<target name="prepare-all" depends="package,eclipse,compile-test,copy-asm" />

	<target name="clean">
		<delete dir="${bin}" />
		<delete dir="${build}" />
		<delete dir="${build.thread}" />
		<delete dir="${build.afterbootstrap}" />
		<exec executable="make" dir="${src.agent.c}">
			<arg value="clean" />
		</exec>
		<exec executable="make" dir="${src.reagent}">
			<arg value="clean" />
		</exec>
		

	</target>

	<!-- *** test instrumentaion package *** -->

	<target name="check-test-property">
		<condition property="test.set">
			<isset property="test.name"/>
		</condition>
	</target>

	<target name="report-missing-property" depends="check-test-property" unless="test.set">
		<fail message="Property test.name is not set. Set it using -Dtest.name=value" />
	</target>

	<property name="test.path" value="ch/usi/dag/disl/test/${test.name}"/>

	<target name="package-test" depends="report-missing-property,prepare-all" description="create instrumentation package for specified test">
		<mkdir dir="${build}"/>
		<jar jarfile="${build}/${instr.jar.name}"
		     basedir="${bin}"
		     includes="${test.path}/**"
		     excludes="${test.path}/TargetClass*.class ${test.path}/MANIFEST.MF"
		     manifest="${src.test}/${test.path}/MANIFEST.MF">
		</jar>
	</target>

</project>
