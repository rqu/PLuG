<project name="disl" default="package" basedir=".">

	<property file="build.properties"/>
	<property file="disl.version"/>

	<path id="buildpath">
		<pathelement location="${asm.path}"/>
		<pathelement location="${bin}"/>
	</path>

	<!-- it automatically compiles all other necessary stuff :) -->
	<target name="compile-tlvinserter">
		<mkdir dir="${bin}"/>
		<javac srcdir="${src.disl}" includes="ch/usi/dag/disl/utilinstr/tlvinserter/" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath"/>
		</javac>
	</target>

	<target name="prepare-extendedthread" depends="compile-tlvinserter">
		<mkdir dir="bin-thread/java/lang"/>
		<java fork="true" classname="ch.usi.dag.disl.utilinstr.tlvinserter.ExtendThread">
			<classpath refid="buildpath"/>
		</java>
		<mkdir dir="${build}"/>
		<jar basedir="bin-thread" destfile="${extendthread.path}" />
		<delete dir="bin-thread"/>
	</target>

	<target name="compile-dynamicbypass" depends="prepare-extendedthread">
		<mkdir dir="${bin}"/>
		<javac srcdir="${src.dynbypass}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath"/>
			<compilerarg value="-Xbootclasspath/p:${extendthread.path}"/>
		</javac>
		<delete file="${extendthread.path}"/>
	</target>

	<target name="compile-disl" depends="compile-dynamicbypass">
		<javac srcdir="${src.disl}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath"/>
		</javac>
	</target>

	<target name="compile-agent-java" depends="compile-dynamicbypass">
		<javac srcdir="${src.agent.java}" destdir="${bin}" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath"/>
		</javac>
	</target>

	<target name="compile-test" depends="compile-disl">
		<javac srcdir="${src.test}" destdir="bin" debug="true" includeAntRuntime="false">
			<classpath refid="buildpath"/>
		</javac>
	</target>

	<target name="compile" depends="compile-disl,compile-agent-java,compile-test"/>

	<target name="prepare-dynamicbypass-afterbootstrap"/>

	<target name="package-dislserver" depends="compile-disl,prepare-dynamicbypass-afterbootstrap">
		<jar basedir="${bin}" destfile="${build}/disl-${disl.version}.jar">
			<manifest>
				<attribute name="Class-Path" value="${instr.jar.name}"/>
			</manifest>
		</jar>
	</target>

	<target name="package" depends="compile,prepare-dynamicbypass-afterbootstrap">
		<jar basedir="${bin}" destfile="${build}/disl-${disl.version}.jar">
			<manifest>
				<attribute name="Class-Path" value="${instr.jar.name}"/>
			</manifest>
		</jar>
	</target>

	<target name="eclipse-agent" description="creates simple agent jar file for eclipse" >
		<mkdir dir="build"/>
		<jar jarfile="build/eclipse-agent.jar">
			<manifest>
				<attribute name="Premain-Class" value="ch.usi.dag.disl.testtools.agent.Agent"/>
			</manifest>
		</jar>
	</target>
	
	<target name="eclipse-dynamicbypass" depends="compile-dynamicbypass" description="creates support library for DiSL development under eclipse">
		<jar basedir="${bin}" destfile="${build}/eclipse-dynamicbypass.jar" includes="ch/usi/dag/disl/dynamicbypass/" />
	</target>
	
	<target name="eclipse" depends="eclipse-dynamicbypass,eclipse-agent"/>

	<target name="clean">
		<delete dir="${bin}"/>
		<delete dir="${build}"/>
	</target>

</project>
